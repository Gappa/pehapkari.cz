image: docker:git

services:
  - docker:dind

variables:
  IMAGE_PHP: registry.gitlab.com/jm-tv-rename-later/open-project-jm-test/php
  IMAGE_NGINX: registry.gitlab.com/jm-tv-rename-later/open-project-jm-test/nginx

before_script:
  - echo $CI_BUILD_TOKEN | docker login -u gitlab-ci-token registry.gitlab.com --password-stdin

build open-training images:
  stage: build
  script:
    - docker pull $IMAGE_PHP || true
    - docker build --cache-from $IMAGE_PHP -t $IMAGE_PHP:$CI_COMMIT_SHA -t $IMAGE_PHP:latest --target production -f projects/open-training/Dockerfile .
    - docker push $IMAGE_PHP
    - docker build --cache-from $IMAGE_PHP --cache-from $IMAGE_NGINX -t $IMAGE_NGINX:$CI_COMMIT_SHA -t $IMAGE_NGINX:latest --target nginx -f projects/open-training/Dockerfile .
    - docker push $IMAGE_NGINX
