dist: trusty

jobs:
    include:
        - stage: build
          if: NOT type = cron
          name: Build docker image
          script:
              - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
              - docker pull pehapkari/pehapkari.cz || true
              - docker build --cache-from pehapkari/pehapkari.cz -t pehapkari/pehapkari.cz:$TRAVIS_COMMIT --target production -f Dockerfile .
              - docker push pehapkari/pehapkari.cz

        - stage: test
          script: docker run --rm pehapkari/pehapkari.cz:$TRAVIS_COMMIT composer check-cs
          name: ECS
        - script: docker run --rm pehapkari/pehapkari.cz:$TRAVIS_COMMIT composer phpstan
          name: PHPStan
        - script: docker run --rm pehapkari/pehapkari.cz:$TRAVIS_COMMIT php vendor/bin/phpunit
          name: PHPUnit
        - script: docker run --rm pehapkari/pehapkari.cz:$TRAVIS_COMMIT bin/console lint:yaml src packages
          name: Lint yaml
        - script: docker run --rm pehapkari/pehapkari.cz:$TRAVIS_COMMIT bin/console lint:twig packages templates
          name: Lint templates
        - script: docker run --rm pehapkari/pehapkari.cz:$TRAVIS_COMMIT composer dead-links
          name: Dead links
        - script: docker run --rm -e APP_ENV=prod pehapkari/pehapkari.cz:$TRAVIS_COMMIT bin/console cache:warmup
          name: Prod cache warmup

        - stage: deploy
          name: Deploy to pehapkari.cz
          if: branch = master AND type = push
          before_script:
            - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
            - docker pull pehapkari/pehapkari.cz:$TRAVIS_COMMIT
            - docker tag pehapkari/pehapkari.cz:$TRAVIS_COMMIT pehapkari/pehapkari.cz:latest
            - docker push pehapkari/pehapkari.cz
          script:
            - eval $(ssh-agent -s)
            - mkdir -p ~/.ssh
            - ssh-keyscan -H pehapkari.cz >> ~/.ssh/known_hosts
            - echo "$DEPLOY_PRIVATE_KEY" | ssh-add - > /dev/null
            - ssh root@pehapkari.cz "cd /projects/pehapkari.cz && ./run.sh"

        - stage: deploy
          name: Deploy to new.pehapkari.cz
          if: branch = design-in-a-day
          before_script:
            - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
            - docker pull pehapkari/pehapkari.cz:$TRAVIS_COMMIT
            - docker tag pehapkari/pehapkari.cz:$TRAVIS_COMMIT pehapkari/pehapkari.cz:design-in-a-day
            - docker push pehapkari/pehapkari.cz
          script:
            - eval $(ssh-agent -s)
            - mkdir -p ~/.ssh
            - ssh-keyscan -H pehapkari.cz >> ~/.ssh/known_hosts
            - echo "$DEPLOY_PRIVATE_KEY" | ssh-add - > /dev/null
            - ssh root@pehapkari.cz "cd /projects/pehapkari.cz && ./run-new.sh"

        - stage: after build
          name: tweet posts
          if: branch = master AND type = cron
          script: vendor/bin/statie tweet-post statie/source

# do not send success notifications, they have no value
notifications:
    email:
        on_success: never
